{% extends "base.html" %}

{% block title %}Editar Transação - Controlador Financeiro{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Editar Transação</h2>
</div>

<div class="form-container">
    <form method="POST" class="transaction-form">
        <div class="form-group">
            <label for="type">Tipo:</label>
            <select id="type" name="type" required class="form-control">
                <option value="income" {% if transaction.type == 'income' %}selected{% endif %}>Receita</option>
                <option value="expense" {% if transaction.type == 'expense' %}selected{% endif %}>Despesa</option>
            </select>
        </div>

        <div class="form-group">
            <label for="amount">Valor:</label>
            <input 
                type="number" 
                id="amount" 
                name="amount" 
                required 
                step="0.01"
                min="0.01"
                value="{{ transaction.amount.amount }}"
                class="form-control"
            >
        </div>

        <div class="form-group">
            <label for="description">Descrição:</label>
            <input 
                type="text" 
                id="description" 
                name="description" 
                required 
                value="{{ transaction.description }}"
                class="form-control"
            >
        </div>

        <div class="form-group">
            <label for="category">Categoria:</label>
            <select id="category" name="category" required class="form-control">
                {% for cat in categories.income %}
                <option value="{{ cat.id }}" data-type="income" {% if transaction.category.id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                {% endfor %}
                {% for cat in categories.expense %}
                <option value="{{ cat.id }}" data-type="expense" {% if transaction.category.id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                {% endfor %}
            </select>
            <small class="help-text">
                <a href="{{ url_for('category.list_categories') }}" target="_blank">Gerenciar categorias</a>
            </small>
        </div>

        <div class="form-group">
            <label for="occurred_at">Data:</label>
            <input 
                type="datetime-local" 
                id="occurred_at" 
                name="occurred_at" 
                value="{{ transaction.occurred_at.strftime('%Y-%m-%dT%H:%M') }}"
                class="form-control"
            >
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Atualizar Transação</button>
            <a href="{{ url_for('transaction.list_transactions') }}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

<script>
    // Variável global para armazenar o ID da categoria atual da transação
    const currentCategoryId = "{{ transaction.category.id }}";
</script>
{% endblock %}

{% block extra_js %}
<script>
    // Adaptação do JS para edição:
    // 1. O JS principal (main.js) já tem a lógica de carregamento dinâmico de categorias.
    // 2. Precisamos garantir que a categoria atual da transação seja pré-selecionada.
    
    document.addEventListener('DOMContentLoaded', function() {
        const typeSelect = document.getElementById('type');
        const categorySelect = document.getElementById('category');
        const currentCategoryId = "{{ transaction.category.id }}"; // Usar o ID da categoria

        // A lógica de carregamento dinâmico via JS não é mais necessária, pois todas as categorias
        // são carregadas no template e a visibilidade será controlada via JS.
        // A pré-seleção é feita diretamente no Jinja.

        // O JS agora só precisa garantir que apenas as categorias do tipo selecionado sejam visíveis.
        const filterCategories = (type) => {
            const options = categorySelect.querySelectorAll('option[data-type]');
            options.forEach(option => {
                if (option.getAttribute('data-type') === type) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                    option.selected = false; // Desseleciona as categorias ocultas
                }
            });
            // Garante que a opção "Selecione uma categoria" esteja visível
            categorySelect.querySelector('option[value=""]').style.display = '';
        };

        // Adiciona listener para o select de Tipo
        typeSelect.addEventListener('change', () => filterCategories(typeSelect.value));
        
        // Dispara o filtro inicial
        filterCategories(typeSelect.value);
    });
</script>
{% endblock %}
